
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>VM workloads - QCon 2022 - Istio Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vm-workloads" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="QCon 2022 - Istio Workshop" class="md-header__button md-logo" aria-label="QCon 2022 - Istio Workshop" data-md-component="logo">
      
  <img src="../assets/tetrate-logo-white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            QCon 2022 - Istio Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              VM workloads
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tetratelabs/qcon-labs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="QCon 2022 - Istio Workshop" class="md-nav__button md-logo" aria-label="QCon 2022 - Istio Workshop" data-md-component="logo">
      
  <img src="../assets/tetrate-logo-white.png" alt="logo">

    </a>
    QCon 2022 - Istio Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tetratelabs/qcon-labs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../environment/" class="md-nav__link">
        Lab environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Install Istio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../sidecar-injection/" class="md-nav__link">
        Sidecar injection
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../the-app/" class="md-nav__link">
        The application
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../discovery/" class="md-nav__link">
        Service discovery and load balancing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ingress/" class="md-nav__link">
        Ingress
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../dashboards/" class="md-nav__link">
        Observability
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        Security
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../traffic-shifting/" class="md-nav__link">
        Traffic shifting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../circuit_breakers/" class="md-nav__link">
        Circuit breakers
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          VM workloads
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        VM workloads
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#istio-mesh-installation" class="md-nav__link">
    Istio mesh installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-and-configuring-the-east-west-gateway" class="md-nav__link">
    Installing and configuring the east-west gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-virtual-machine-namespace-and-files" class="md-nav__link">
    Preparing virtual machine namespace and files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-default-compute-region-and-zone" class="md-nav__link">
    Set default compute region and zone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-virtual-machine" class="md-nav__link">
    Create the Virtual Machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-configuration-to-the-virtual-machine" class="md-nav__link">
    Applying configuration to the Virtual Machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-services-from-the-virtual-machine" class="md-nav__link">
    Access services from the virtual machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-services-on-the-virtual-machine" class="md-nav__link">
    Run services on the virtual machine
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../summary/" class="md-nav__link">
        Summary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#istio-mesh-installation" class="md-nav__link">
    Istio mesh installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-and-configuring-the-east-west-gateway" class="md-nav__link">
    Installing and configuring the east-west gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-virtual-machine-namespace-and-files" class="md-nav__link">
    Preparing virtual machine namespace and files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-default-compute-region-and-zone" class="md-nav__link">
    Set default compute region and zone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-virtual-machine" class="md-nav__link">
    Create the Virtual Machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-configuration-to-the-virtual-machine" class="md-nav__link">
    Applying configuration to the Virtual Machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-services-from-the-virtual-machine" class="md-nav__link">
    Access services from the virtual machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-services-on-the-virtual-machine" class="md-nav__link">
    Run services on the virtual machine
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/tetratelabs/qcon-labs/edit/main/docs/vm_workloads.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="vm-workloads">VM workloads<a class="headerlink" href="#vm-workloads" title="Permanent link">&para;</a></h1>
<p>In this lab, we will learn how to connect a workload running on a virtual machine to the Istio service mesh running on a Kubernetes cluster. Both Kubernetes cluster and the virtual machine will be running on Google Cloud Platform (GCP).</p>
<h2 id="istio-mesh-installation">Istio mesh installation<a class="headerlink" href="#istio-mesh-installation" title="Permanent link">&para;</a></h2>
<p>After we've created a Kubernetes cluster, we can download, install Istio, and configure Istio. We are using a pre-alpha feature that automatically creates WorkloadEntries for our VMs. To support this, we have to set the <code>PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION</code> variable to true when installing Istio on the Kubernetes cluster.</p>
<p>Since we already installed Istio, we'll just update the existing installation using the IstioOperator. </p>
<p>One of the differences between regular Istio installation and one that supports VM workloads is in setting cluster name and network. In this lab we'll set the network name to an empty string because we'll only use a single network - i.e. both the VM and the Kubernetes will be part of the same network. </p>
<p>If had a scenario where the VM was running in a different network as the Kubernetes cluster, we'd set the network name to differentiate the networks.</p>
<details class="note">
<summary>Click for istio-vm-install.yaml</summary>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">istio-vm-install.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install.istio.io/v1alpha1</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IstioOperator</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">values</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nt">global</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">      </span><span class="nt">meshID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mesh1</span><span class="w"></span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">      </span><span class="nt">multiCluster</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Kubernetes</span><span class="w"></span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">      </span><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="nt">pilot</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="nt">PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="nt">PILOT_ENABLE_WORKLOAD_ENTRY_HEALTHCHECKS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</details>
<p>Save the above YAML to <code>istio-vm-install.yaml</code>.</p>
<p>We'll use <code>istioctl</code> to install Istio on the cluster:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>istioctl install -f istio-vm-install.yaml
</code></pre></div>
<p>Once the installation completes, we can deploy a separate ingress gateway that will be used to expose the Istio's control plane to the virtual machine.</p>
<h2 id="installing-and-configuring-the-east-west-gateway">Installing and configuring the east-west gateway<a class="headerlink" href="#installing-and-configuring-the-east-west-gateway" title="Permanent link">&para;</a></h2>
<p>The Istio package we downloaded contains a script we can use to generate the YAML that will deploy an Istio operator that creates the new gateway called <code>istio-eastwestgateway</code>.</p>
<p>Go to the folder where you downloaded Istio (e.g. <code>istio-1.15.2</code>) and run this script:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>samples/multicluster/gen-eastwest-gateway.sh --single-cluster <span class="p">|</span> istioctl install -y -f -
</code></pre></div>
<p>You can list the Pods in the <code>istio-system</code> namespaces to check the gateway that was installed:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>kubectl get po -n istio-system
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="go">NAME                                     READY   STATUS    RESTARTS   AGE</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">istio-eastwestgateway-6d47fc4ddf-m89wn   1/1     Running   0          17s</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="go">istio-egressgateway-7767c67b7c-wmpcw     1/1     Running   0          11m</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="go">istio-ingressgateway-f5b854689-j9tcr     1/1     Running   0          11m</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">istiod-65cc74b9c7-j5n4d                  1/1     Running   0          4m59s</span>
</code></pre></div>
<p>For virtual machines to access the Istio's control plane, we need to create a Gateway resource to configure the <code>istio-eastwestgateway</code>, and a VirtualService that has the Gateway attached.</p>
<p>We can use another script from the Istio package to create these resources and expose the control plane:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>kubectl apply -n istio-system -f samples/multicluster/expose-istiod.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="go">gateway.networking.istio.io/istiod-gateway created</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">virtualservice.networking.istio.io/istiod-vs created</span>
</code></pre></div>
<p>The above resources (Gateway and VirtualService) configure the eastwest-gateway to listen on ports 15012 (used for control plane - istiod) and 15017 (used for pilot discovery validation webhook). The VirtualService matches the requests on the two ports and then routes them to istiod to appropriate ports.</p>
<p>The purpose of the eastwest-gateway in this scenario will be to allow the Istio sidecar proxy on the virtual machine to call the control plane running inside the cluster. The second role of the eastwest-gateway is in the scenarios where the VM and Kubernetes cluster are running in different networks. In that scenario, the workloads communicate to each through the eastwest-gateway.</p>
<h2 id="preparing-virtual-machine-namespace-and-files">Preparing virtual machine namespace and files<a class="headerlink" href="#preparing-virtual-machine-namespace-and-files" title="Permanent link">&para;</a></h2>
<p>For the virtual machine workloads, we have to create a separate namespace to store the WorkloadEntry resource and any other VM workload related resources. Additionally, we will have to export the cluster environment file, token, certificate, and other files we will have to transfer to the virtual machine.</p>
<p>Let's create a separate folder called <code>vm-files</code> to store these files. We can also save the full path to the folder in the <code>WORK_DIR</code> environment variable:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>mkdir -p vm-files
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nb">export</span> <span class="nv">WORK_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PWD</span><span class="s2">/vm-files&quot;</span>
</code></pre></div>
<p>We also set a couple of environment variables before continuing, so we don't have to re-type the values each time:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nb">export</span> <span class="nv">VM_APP</span><span class="o">=</span><span class="s2">&quot;hello-vm&quot;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nb">export</span> <span class="nv">VM_NAMESPACE</span><span class="o">=</span><span class="s2">&quot;vm-namespace&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nb">export</span> <span class="nv">SERVICE_ACCOUNT</span><span class="o">=</span><span class="s2">&quot;vm-sa&quot;</span>
</code></pre></div>
<p>Let's create the VM namespace and the service account we will use for VM workloads in the same namespace:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>kubectl create ns <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">namespace/vm-namespace created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>kubectl create serviceaccount <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SERVICE_ACCOUNT</span><span class="si">}</span><span class="s2">&quot;</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="go">serviceaccount/vm-sa created</span>
</code></pre></div>
<p>Next we'll create the WorkloadGroup resource using Istio CLI. Run the command to save the WorkloadGroup YAML to <code>workloadgroup.yaml</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>istioctl x workload group create --name <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_APP</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>  --namespace <span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_NAMESPACE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>  --labels <span class="nv">app</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VM_APP</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  --serviceAccount <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SERVICE_ACCOUNT</span><span class="si">}</span><span class="s2">&quot;</span> &gt; workloadgroup.yaml
</code></pre></div>
<p>Here's how the contents of the <code>workloadgroup.yaml</code> should look like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1alpha3</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WorkloadGroup</span><span class="w"></span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-vm</span><span class="w"></span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vm-namespace</span><span class="w"></span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-vm</span><span class="w"></span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vm-sa</span><span class="w"></span>
</code></pre></div>
<p>Save the above YAML to <code>workloadgroup.yaml</code> and create the resource:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>kubectl apply -f workloadgroup.yaml
</code></pre></div>
<p>Virtual machine needs information about the cluster and Istio's control plane to connect to it. To generate the required files, we can run <code>istioctl x workload entry</code> command. We save all generated files to the <code>WORK_DIR</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>istioctl x workload entry configure <span class="se">\</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>  -f workloadgroup.yaml <span class="se">\</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>  -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORK_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>  --autoregister <span class="se">\</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>  --clusterID <span class="s2">&quot;Kubernetes&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="go">warning: a security token for namespace vm-namespace and service account vm-sa has been generated and stored at /vm-files/istio-token</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">configuration generation into directory /vm-files was successful</span>
</code></pre></div>
<details class="warning">
<summary>VM onboarding is not a one-time action</summary>
<p>Whenever we update the WorkloadGroup resource, we also have to re-create the configuration (run the <code>istioctl x workload entry configure</code> command) and copy the generated files to the virtual machine.</p>
</details>
<p>The above command generates the following files:</p>
<ul>
<li><code>cluster.env</code>: Contains metadata that identifies what namespace, service account, network CIDR and (optionally) what inbound ports to capture.</li>
<li><code>istio-token</code>: A Kubernetes token used to get certs from the CA. This is the the token from the <code>vm-sa</code> service account that's created using the <code>istio-ca</code> audience.</li>
<li><code>mesh.yaml</code>: Provides <code>ProxyConfig</code> to configure <code>discoveryAddress</code>, health-checking probes, and some authentication options.</li>
<li><code>root-cert.pem</code>: The root certificate used to authenticate. Comes from the <code>istio-ca-root-cert</code> ConfigMap in the <code>vm-namespace</code> namespace.</li>
<li><code>hosts</code>: An addendum to /etc/hosts that the proxy will use to reach istiod for xDS.</li>
</ul>
<p>We'll copy the these files to the virtual machine, to locations known by the Envoy proxy. Note that the location where the files are copied can be customized, but it requires updates to the initial Envoy proxy configuration.</p>
<p>The files provide the Envoy proxy bootstrap configuration - they tell the proxy the information about the workload (e.g. the workload and service name and the namespace, the WorkloadGroup name, cluster ID and mesh ID and others).</p>
<p>To onboard the VM workload the sidecar also nees the Istio mTLS certificate. When the sidcear starts it uses the <code>istio-token</code> file to prove its identity to Istio control plane and to obtain the Istio mTLS certificate. The mTLS certificate is stored on disk for cases when the VM restarts.</p>
<p>The expiration time on the initial <code>istio-token</code> is 1 hour. If it takes you longer than 1 hour to onboard the VM, you' ll need to re-run the <code>istioctl x workload entry configure</code> command to generate a new token.</p>
<p>Once the VM obtains the mTLS certificate, it can use it to prove its identity. The certificate is valid for 24 hours and the proxy will automatically refresh it before it expires.</p>
<h2 id="set-default-compute-region-and-zone">Set default compute region and zone<a class="headerlink" href="#set-default-compute-region-and-zone" title="Permanent link">&para;</a></h2>
<p>Configuring the default and region and zone helps avoid specifying them in subsequent commands:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>gcloud config <span class="nb">set</span> compute/region us-west1
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>gcloud config <span class="nb">set</span> compute/zone us-west1-a
</code></pre></div>
<h2 id="create-the-virtual-machine">Create the Virtual Machine<a class="headerlink" href="#create-the-virtual-machine" title="Permanent link">&para;</a></h2>
<p>We'll be running the virtual machine in GCP, just like the Kubernetes cluster.</p>
<ol>
<li>
<p>Create the VM</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>gcloud compute instances create my-mesh-vm <span class="se">\</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>  --tags<span class="o">=</span>mesh-vm <span class="se">\</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>  --machine-type<span class="o">=</span>n1-standard-2
</code></pre></div>
</li>
<li>
<p>Obtain the cluster's Pod IP address range.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">export</span> <span class="nv">CLUSTER_POD_CIDR</span><span class="o">=</span><span class="k">$(</span>gcloud container clusters list --format<span class="o">=</span>json <span class="p">|</span> jq -r <span class="s1">&#39;.[0].clusterIpv4Cidr&#39;</span><span class="k">)</span>
</code></pre></div>
</li>
<li>
<p>Create a firewall rule to allow ingress on port 80 from the cluster pods to the VM.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>gcloud compute firewall-rules create <span class="s2">&quot;cluster-pods-to-vm&quot;</span> <span class="se">\</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>  --source-ranges<span class="o">=</span><span class="nv">$CLUSTER_POD_CIDR</span> <span class="se">\</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>  --target-tags<span class="o">=</span>mesh-vm <span class="se">\</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>  --action<span class="o">=</span>allow <span class="se">\</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>  --rules<span class="o">=</span>tcp:80
</code></pre></div>
</li>
</ol>
<h2 id="applying-configuration-to-the-virtual-machine">Applying configuration to the Virtual Machine<a class="headerlink" href="#applying-configuration-to-the-virtual-machine" title="Permanent link">&para;</a></h2>
<p>Now it's time to configure the Virtual machine. In this example, we run a simple Python HTTP server on port 80. You could configure any other service on a different port. Just make sure you configure the security and firewall rules accordingly.</p>
<ol>
<li>
<p>Copy the files from <code>vm-files</code> folder to the home folder on the instance.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>gcloud compute scp vm-files/* my-mesh-vm:~
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="go">cluster.env              100%  627   626.9KB/s   00:00</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="go">hosts                    100%   36    50.7KB/s   00:00</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="go">istio-token              100%  905     1.4MB/s   00:00</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="go">mesh.yaml                100%  668   918.7KB/s   00:00</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="go">root-cert.pem            100% 1094     1.7MB/s   00:00</span>
</code></pre></div>
</li>
<li>
<p>SSH into the instance and copy the root certificate to <code>/etc/certs</code> (you can use the command from the instance details page in the SSH dropdown):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>gcloud compute ssh my-mesh-vm
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>sudo mkdir -p /etc/certs
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>sudo cp root-cert.pem /etc/certs/root-cert.pem
</code></pre></div>
</li>
<li>
<p>Copy the <code>istio-token</code> file to <code>/var/run/secrets/tokens</code> folder:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>sudo mkdir -p /var/run/secrets/tokens
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>sudo cp istio-token /var/run/secrets/tokens/istio-token
</code></pre></div>
</li>
<li>
<p>Download and install the Istio sidecar package:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>curl -LO https://storage.googleapis.com/istio-release/releases/1.15.2/deb/istio-sidecar.deb
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>sudo dpkg -i istio-sidecar.deb
</code></pre></div>
</li>
<li>
<p>Copy <code>cluster.env</code> to <code>/var/lib/istio/envoy/</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>sudo cp cluster.env /var/lib/istio/envoy/cluster.env
</code></pre></div>
</li>
<li>
<p>Copy Mesh config (<code>mesh.yaml</code>) to <code>/etc/istio/config/mesh</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>sudo cp mesh.yaml /etc/istio/config/mesh
</code></pre></div>
</li>
<li>
<p>Add the istiod host to the <code>/etc/hosts</code> file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>sudo sh -c <span class="s1">&#39;cat $(eval echo ~$SUDO_USER)/hosts &gt;&gt; /etc/hosts&#39;</span>
</code></pre></div>
</li>
<li>
<p>Change the ownership of files in <code>/etc/certs</code> and <code>/var/lib/istio/envoy</code> to the Istio proxy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>sudo mkdir -p /etc/istio/proxy
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>sudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /etc/istio/config /var/run/secrets /etc/certs/root-cert.pem
</code></pre></div>
</li>
</ol>
<p>With all files in place, we are ready to start Istio on the virtual machine.</p>
<p>Because we used the VM auto-registration, Istio automatically creates the WorkloadEntry resource for us shortly after we start the Istio service on the VM.</p>
<p>You can see the WorkloadEntry creation <em>in action</em> as follows:</p>
<ol>
<li>
<p>Watch for Workloadentry resources using the <code>--watch</code> flag</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>kubectl get workloadentry -n vm-namespace --watch
</code></pre></div>
</li>
<li>
<p>On the VM, start the Istio service:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>sudo systemctl start istio
</code></pre></div>
</li>
<li>
<p>You should see the WorkloadEntry appear</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="go">NAME                  AGE   ADDRESS</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="go">hello-vm-10.128.0.7   12m   10.128.0.7</span>
</code></pre></div>
</li>
<li>
<p>Press Ctrl-C to stop watching for changes.</p>
</li>
</ol>
<p>On the VM, you can check that the <code>istio</code> service is running with <code>systemctl status istio</code>. Alternatively, we can look at the contents of the <code>/var/log/istio/istio.log</code> to see that the proxy was successfully started.</p>
<p>At this point, the virtual machine is configured to talk with the Istio's control plane in the Kubernetes cluster.</p>
<h2 id="access-services-from-the-virtual-machine">Access services from the virtual machine<a class="headerlink" href="#access-services-from-the-virtual-machine" title="Permanent link">&para;</a></h2>
<p>From a different terminal window, we can now deploy a Hello world application to the Kubernetes cluster</p>
<details class="note">
<summary>Click for hello-world.yaml</summary>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">hello-world.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span>
<span class="normal"><a href="#__codelineno-36-33">33</a></span>
<span class="normal"><a href="#__codelineno-36-34">34</a></span>
<span class="normal"><a href="#__codelineno-36-35">35</a></span>
<span class="normal"><a href="#__codelineno-36-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io/tetratelabs/hello-world:1.0.0</span><span class="w"></span>
<a id="__codelineno-36-19" name="__codelineno-36-19"></a><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w"></span>
<a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">svc</span><span class="w"></span>
<a id="__codelineno-36-21" name="__codelineno-36-21"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span><span class="w"></span>
<a id="__codelineno-36-23" name="__codelineno-36-23"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-36-24" name="__codelineno-36-24"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-36-26" name="__codelineno-36-26"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-27" name="__codelineno-36-27"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-28" name="__codelineno-36-28"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-29" name="__codelineno-36-29"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-30" name="__codelineno-36-30"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-31" name="__codelineno-36-31"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-32" name="__codelineno-36-32"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-world</span><span class="w"></span>
<a id="__codelineno-36-33" name="__codelineno-36-33"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-36-34" name="__codelineno-36-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-36-35" name="__codelineno-36-35"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span><span class="w"></span>
<a id="__codelineno-36-36" name="__codelineno-36-36"></a><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
</details>
<p>Save the above YAML to <code>hello-world.yaml</code> and deploy it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>kubectl apply -f hello-world.yaml
</code></pre></div>
<p>Wait for the Pods to become ready and then go back to the virtual machine and try to access the Kubernetes service:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>curl http://hello-world.default
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="go">Hello World</span>
</code></pre></div>
<p>You can access any service running within your Kubernetes cluster from the virtual machine.</p>
<h2 id="run-services-on-the-virtual-machine">Run services on the virtual machine<a class="headerlink" href="#run-services-on-the-virtual-machine" title="Permanent link">&para;</a></h2>
<p>We can also run a workload on the virtual machine. Switch to the virtual machine instance and run a simple Python HTTP server:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>sudo python3 -m http.server <span class="m">80</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="go">Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...</span>
</code></pre></div>
<p>What we want to do next is add the workload (Python HTTP service) to the mesh. For that reason, we created the VM namespace earlier. So let's create a Kubernetes service that represents the VM workload. Note that the name and the label values equal to the value of the <code>VM_APP</code> environment variable we set earlier. Don't forget to deploy the service to the <code>VM_NAMESPACE</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">hello-vm-service.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class="w"></span>
<a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-vm</span><span class="w"></span>
<a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vm-namespace</span><span class="w"></span>
<a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-vm</span><span class="w"></span>
<a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http-vm</span><span class="w"></span>
<a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w"></span>
<a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-vm</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Save the above YAML to <code>hello-vm-service.yaml</code> and deploy it to the VM namespace:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>kubectl apply -f hello-vm-service.yaml
</code></pre></div>
<p>We can now use the Kubernetes service name <code>hello-vm.vm-namespace</code> to access the workload running on the virtual machine (the Python server). Let's run a Pod inside the cluster and try to access the service from there:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>kubectl run curl --image<span class="o">=</span>radial/busyboxplus:curl -i --tty --rm
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="go">If you don&#39;t see a command prompt, try pressing enter.</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="gp">[ root@curl:/ ]$</span>
</code></pre></div>
<p>After you get the command prompt in the Pod, you can run curl and access the workload. You should see a directory listing response. Similarly, you will notice a log entry on the instance where the HTTP server is running:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="o">[</span> root@curl:/ <span class="o">]</span>$ curl hello-vm.vm-namespace
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="go">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;http://www.w3.org/TR/html4/strict.dt</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="go">d&quot;&gt;</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="go">&lt;html&gt;</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="go">&lt;head&gt;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="go">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="go">&lt;title&gt;Directory listing for /&lt;/title&gt;</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="go">&lt;/head&gt;</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="go">&lt;body&gt;</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="go">&lt;h1&gt;Directory listing for /&lt;/h1&gt;</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="go">&lt;hr&gt;</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="go">...</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../circuit_breakers/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Circuit breakers" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Circuit breakers
            </div>
          </div>
        </a>
      
      
        
        <a href="../summary/" class="md-footer__link md-footer__link--next" aria-label="Next: Summary" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Summary
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top", "navigation.instant", "navigation.tracking", "content.code.annotate", "navigation.expand"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>